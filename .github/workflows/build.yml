name: Build SeedSigner OS

on:
  push:
    branches: [ main, develop, master ]
  pull_request:
    branches: [ main, develop, master ]
  workflow_dispatch:
    inputs:
      hardware_type:
        description: 'Hardware Type'
        required: true
        type: choice
        options:
          - RV1103_Luckfox_Pico_Mini
          - RV1106_Luckfox_Pico_Pro_Max
        default: 'RV1103_Luckfox_Pico_Mini'
      boot_medium:
        description: 'Boot Medium'
        required: true
        type: choice
        options:
          - SD_CARD
          - SPI_NAND
        default: 'SD_CARD'

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 180  # 3 hours max
    permissions:
      contents: read
    strategy:
      matrix:
        include:
          # When manually triggered via workflow_dispatch, use the selected inputs
          # Otherwise, build all 4 combinations
          ${{ github.event_name == 'workflow_dispatch' && fromJSON(format('[{{"hardware":"{0}","boot":"{1}"}}]', github.event.inputs.hardware_type, github.event.inputs.boot_medium)) || fromJSON('[
            {"hardware":"RV1103_Luckfox_Pico_Mini","boot":"SD_CARD"},
            {"hardware":"RV1103_Luckfox_Pico_Mini","boot":"SPI_NAND"},
            {"hardware":"RV1106_Luckfox_Pico_Pro_Max","boot":"SD_CARD"},
            {"hardware":"RV1106_Luckfox_Pico_Pro_Max","boot":"SPI_NAND"}
          ]') }}
    
    steps:
    - name: Checkout seedsigner-luckfox-pico repository
      uses: actions/checkout@v4
      with:
        path: seedsigner-luckfox-pico

    - name: Free up disk space
      run: |
        sudo apt-get clean
        sudo rm -rf /usr/share/dotnet
        sudo rm -rf /opt/ghc
        sudo rm -rf /usr/local/share/boost
        df -h

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          git ssh make gcc gcc-multilib g++-multilib \
          module-assistant expect g++ gawk texinfo \
          libssl-dev bison flex fakeroot cmake unzip \
          gperf autoconf device-tree-compiler \
          libncurses5-dev pkg-config bc python-is-python3 \
          passwd openssl openssh-server openssh-client \
          vim file cpio rsync

    - name: Clone required repositories
      run: |
        # Clone LuckFox Pico SDK (forked version with SeedSigner modifications)
        # This fork includes hardware customizations like CMA memory settings, pull-up resistors, etc.
        echo "Cloning luckfox-pico SDK..."
        if ! git clone https://github.com/lightningspore/luckfox-pico.git --depth=1 --single-branch; then
          echo "ERROR: Failed to clone luckfox-pico SDK"
          exit 1
        fi
        
        # Clone SeedSigner OS packages (buildroot package definitions)
        echo "Cloning seedsigner-os packages..."
        if ! git clone https://github.com/seedsigner/seedsigner-os.git --depth=1 --single-branch; then
          echo "ERROR: Failed to clone seedsigner-os packages"
          exit 1
        fi
        
        # Clone SeedSigner code (luckfox-dev branch contains LuckFox-specific adaptations)
        echo "Cloning seedsigner application code..."
        if ! git clone https://github.com/lightningspore/seedsigner.git --depth=1 -b luckfox-dev --single-branch; then
          echo "ERROR: Failed to clone seedsigner code (branch: luckfox-dev)"
          echo "This branch may have been renamed or removed"
          exit 1
        fi
        
        echo "All repositories cloned successfully"

    - name: Set up build environment
      run: |
        cd luckfox-pico
        
        # Source the toolchain environment and export to GITHUB_ENV
        cd tools/linux/toolchain/arm-rockchip830-linux-uclibcgnueabihf
        
        # Source the environment script
        source env_install_toolchain.sh
        
        # Export PATH to GITHUB_ENV so it persists to next steps
        echo "PATH=$PATH" >> $GITHUB_ENV
        
        # Also export the CROSS_COMPILE variable if it exists
        if [ -n "$CROSS_COMPILE" ]; then
          echo "CROSS_COMPILE=$CROSS_COMPILE" >> $GITHUB_ENV
        fi
        
        cd ../../../..
        
        # Verify toolchain is accessible
        which arm-rockchip830-linux-uclibcgnueabihf-gcc || echo "WARNING: Toolchain not in PATH yet, but will be in next step"

    - name: Configure board
      run: |
        cd luckfox-pico
        
        HARDWARE="${{ matrix.hardware }}"
        BOOT_MEDIUM="${{ matrix.boot }}"
        
        # Determine the board config file
        BOARD_CONFIG="project/cfg/BoardConfig_IPC/BoardConfig-${BOOT_MEDIUM}-Buildroot-${HARDWARE}-IPC.mk"
        
        if [ ! -f "$BOARD_CONFIG" ]; then
          echo "Error: Board config file not found: $BOARD_CONFIG"
          echo "Available configs:"
          ls -1 project/cfg/BoardConfig_IPC/
          exit 1
        fi
        
        echo "Using board config: $BOARD_CONFIG"
        
        # Create symbolic link to board config at root level
        ln -rfs "$BOARD_CONFIG" .BoardConfig.mk

    - name: Prepare buildroot source tree
      run: |
        cd luckfox-pico
        make buildroot_create -C sysdrv

    - name: Install SeedSigner packages
      run: |
        cd luckfox-pico
        
        # Auto-detect buildroot directory
        BUILDROOT_DIR=$(find sysdrv/source/buildroot -maxdepth 1 -type d -name 'buildroot-*' | sort | tail -n 1)
        
        if [ -z "$BUILDROOT_DIR" ] || [ ! -d "$BUILDROOT_DIR" ]; then
          echo "ERROR: Could not locate buildroot directory under sysdrv/source/buildroot"
          exit 1
        fi
        
        echo "Using buildroot directory: $BUILDROOT_DIR"
        PACKAGE_DIR="${BUILDROOT_DIR}/package"
        
        # Copy SeedSigner packages from seedsigner-os
        cp -rv ../seedsigner-os/opt/external-packages/* "$PACKAGE_DIR/"
        
        # Update pyzbar patch
        # Note: Will be updated with actual Python version after .config is created in next step
        PYZBAR_PATCH="${PACKAGE_DIR}/python-pyzbar/0001-PATH-fixed-by-hand.patch"
        if [ -f "$PYZBAR_PATCH" ]; then
          echo "pyzbar patch found, will be updated after buildroot config is applied"
        fi
        
        # Add SeedSigner menu to buildroot Config.in
        CONFIG_IN="${PACKAGE_DIR}/Config.in"
        if ! grep -q '^menu "SeedSigner"$' "$CONFIG_IN"; then
          cat >> "$CONFIG_IN" << 'EOF'
        menu "SeedSigner"
        	source "package/python-urtypes/Config.in"
        	source "package/python-pyzbar/Config.in"
        	source "package/python-mock/Config.in"
        	source "package/python-embit/Config.in"
        	source "package/python-pillow/Config.in"
        	source "package/libcamera/Config.in"
        	source "package/libcamera-apps/Config.in"
        	source "package/zbar/Config.in"
        	source "package/jpeg-turbo/Config.in.options"
        	source "package/jpeg/Config.in"
        	source "package/python-qrcode/Config.in"
        	source "package/python-pyqrcode/Config.in"
        endmenu
        EOF
        fi

    - name: Apply SeedSigner buildroot configuration
      run: |
        cd luckfox-pico
        
        # Auto-detect buildroot directory
        BUILDROOT_DIR=$(find sysdrv/source/buildroot -maxdepth 1 -type d -name 'buildroot-*' | sort | tail -n 1)
        
        if [ -z "$BUILDROOT_DIR" ] || [ ! -d "$BUILDROOT_DIR" ]; then
          echo "ERROR: Could not locate buildroot directory under sysdrv/source/buildroot"
          exit 1
        fi
        
        echo "Using buildroot directory: $BUILDROOT_DIR"
        
        # Copy SeedSigner defconfig
        cp -v ../seedsigner-luckfox-pico/buildroot/configs/luckfox_pico_defconfig "$BUILDROOT_DIR/configs/luckfox_pico_defconfig"
        cp -v ../seedsigner-luckfox-pico/buildroot/configs/luckfox_pico_defconfig "$BUILDROOT_DIR/.config"
        
        # Now that .config exists, update pyzbar patch with actual Python version if available
        PACKAGE_DIR="${BUILDROOT_DIR}/package"
        PYZBAR_PATCH="${PACKAGE_DIR}/python-pyzbar/0001-PATH-fixed-by-hand.patch"
        if [ -f "$PYZBAR_PATCH" ] && [ -f "$BUILDROOT_DIR/.config" ]; then
          PYTHON_VER="3.11"
          DETECTED_PYTHON_VER=$(grep -oP 'BR2_PACKAGE_PYTHON3_VERSION="\K[^"]+' "$BUILDROOT_DIR/.config" 2>/dev/null || true)
          if [ -n "$DETECTED_PYTHON_VER" ]; then
            PYTHON_VER="$DETECTED_PYTHON_VER"
            sed -i "s|path = \".*/site-packages/zbar.so\"|path = \"/usr/lib/python${PYTHON_VER}/site-packages/zbar.so\"|" "$PYZBAR_PATCH"
            echo "Updated pyzbar patch for Python ${PYTHON_VER} (detected from config)"
          else
            echo "No Python version found in config; pyzbar patch already set to default Python ${PYTHON_VER}"
          fi
        fi

    - name: Build system
      run: |
        cd luckfox-pico
        
        ./build.sh uboot
        ./build.sh kernel
        ./build.sh rootfs
        ./build.sh media
        ./build.sh app

    - name: Install SeedSigner application
      run: |
        cd luckfox-pico
        
        # Find rootfs directory
        ROOTFS_DIRS=($(find output/out -maxdepth 1 -type d -name "rootfs_uclibc_*"))
        
        if [ ${#ROOTFS_DIRS[@]} -eq 0 ]; then
          echo "ERROR: Could not find rootfs directory"
          exit 1
        elif [ ${#ROOTFS_DIRS[@]} -gt 1 ]; then
          echo "WARNING: Multiple rootfs directories found:"
          printf '  %s\n' "${ROOTFS_DIRS[@]}"
          echo "Using first match: ${ROOTFS_DIRS[0]}"
        fi
        
        ROOTFS_DIR="${ROOTFS_DIRS[0]}"
        echo "Using rootfs directory: $ROOTFS_DIR"
        
        # Copy SeedSigner code
        cp -rv ../seedsigner/src/ "$ROOTFS_DIR/seedsigner"
        
        # Copy configuration files
        cp -v ../seedsigner-luckfox-pico/buildroot/files/luckfox.cfg "$ROOTFS_DIR/etc/luckfox.cfg"
        cp -v ../seedsigner-luckfox-pico/buildroot/files/nv12_converter "$ROOTFS_DIR/"
        cp -v ../seedsigner-luckfox-pico/buildroot/files/start-seedsigner.sh "$ROOTFS_DIR/"
        cp -v ../seedsigner-luckfox-pico/buildroot/files/S99seedsigner "$ROOTFS_DIR/etc/init.d/"

    - name: Package firmware
      run: |
        cd luckfox-pico
        ./build.sh firmware

    - name: Create flashable SD image
      if: matrix.boot == 'SD_CARD'
      run: |
        cd luckfox-pico/output/image
        
        HARDWARE="${{ matrix.hardware }}"
        TIMESTAMP=$(date +%Y%m%d_%H%M%S)
        
        # Determine board label (mini or max)
        if [[ "$HARDWARE" == *"Mini"* ]]; then
          BOARD_LABEL="mini"
        elif [[ "$HARDWARE" == *"Max"* ]]; then
          BOARD_LABEL="max"
        else
          BOARD_LABEL="unknown"
        fi
        
        IMAGE_NAME="seedsigner-luckfox-pico-${BOARD_LABEL}-sd-${TIMESTAMP}.img"
        
        # Use blkenvflash to create the SD image
        ../../../seedsigner-luckfox-pico/buildroot/blkenvflash "$IMAGE_NAME"
        
        # Create artifacts directory and copy image
        mkdir -p ../../../build-artifacts
        cp -v "$IMAGE_NAME" ../../../build-artifacts/

    - name: Create NAND flash bundle
      if: matrix.boot == 'SPI_NAND'
      run: |
        cd luckfox-pico/output/image
        
        HARDWARE="${{ matrix.hardware }}"
        TIMESTAMP=$(date +%Y%m%d_%H%M%S)
        
        # Determine board label (mini or max)
        if [[ "$HARDWARE" == *"Mini"* ]]; then
          BOARD_LABEL="mini"
        elif [[ "$HARDWARE" == *"Max"* ]]; then
          BOARD_LABEL="max"
        else
          BOARD_LABEL="unknown"
        fi
        
        # Check that firmware packaging created the required files
        if [[ ! -f "update.img" ]]; then
          echo "ERROR: update.img not found. Firmware packaging may have failed."
          exit 1
        fi
        
        # Create NAND bundle directory
        NAND_BUNDLE_DIR="../../../build-artifacts/seedsigner-luckfox-pico-${BOARD_LABEL}-nand-files-${TIMESTAMP}"
        mkdir -p "$NAND_BUNDLE_DIR"
        
        # Required files for NAND flashing
        REQUIRED_FILES=(
          update.img
          download.bin
          env.img
          idblock.img
          uboot.img
          boot.img
          oem.img
          userdata.img
          rootfs.img
          sd_update.txt
          tftp_update.txt
        )
        
        # Copy files to bundle directory
        MISSING_FILES=()
        for file in "${REQUIRED_FILES[@]}"; do
          if [[ -f "$file" ]]; then
            cp -v "$file" "$NAND_BUNDLE_DIR/"
          else
            MISSING_FILES+=("$file")
          fi
        done
        
        # Report missing files (some may be optional)
        if [[ ${#MISSING_FILES[@]} -ne 0 ]]; then
          echo "WARNING: Some files were not found: ${MISSING_FILES[*]}"
          # Only fail if critical files are missing
          if [[ ! -f "$NAND_BUNDLE_DIR/update.img" ]]; then
            echo "ERROR: Critical file update.img is missing"
            exit 1
          fi
        fi
        
        # Create README for NAND bundle
        cat > "$NAND_BUNDLE_DIR/README.txt" << 'EOF'
        SeedSigner Luckfox NAND Flash Bundle
        
        Contains SDK-generated NAND flashing files:
        - update.img / download.bin
        - partition images (*.img)
        - U-Boot scripts: sd_update.txt and tftp_update.txt
        
        Flash guidance:
        - Use update.img with official Luckfox/Rockchip upgrade tooling, or
        - Use sd_update.txt / tftp_update.txt with U-Boot workflows.
        
        For detailed instructions, see:
        https://wiki.luckfox.com/Luckfox-Pico/Linux-MacOS-Burn-Image/
        EOF
        
        # Create tar.gz archive
        cd ../../../build-artifacts
        NAND_BUNDLE_NAME="seedsigner-luckfox-pico-${BOARD_LABEL}-nand-bundle-${TIMESTAMP}.tar.gz"
        tar -czf "$NAND_BUNDLE_NAME" "$(basename "$NAND_BUNDLE_DIR")"
        
        echo "Created NAND bundle: $NAND_BUNDLE_NAME"
        ls -lh "$NAND_BUNDLE_NAME"

    - name: List build artifacts
      if: always()
      run: |
        echo "ðŸŽ¯ Build artifacts:"
        ls -lah build-artifacts/ 2>/dev/null || echo "No build artifacts directory found"
        
        if [ -d build-artifacts ]; then
          echo ""
          echo "ðŸ“¦ SD Card Images (.img):"
          find build-artifacts -name "*.img" -type f 2>/dev/null | while IFS= read -r f; do
            echo "  $(basename "$f") - $(du -sh "$f" | cut -f1)"
          done || echo "  No SD images found"
          
          echo ""
          echo "ðŸ“¦ NAND Bundles (.tar.gz):"
          find build-artifacts -name "*.tar.gz" -type f 2>/dev/null | while IFS= read -r f; do
            echo "  $(basename "$f") - $(du -sh "$f" | cut -f1)"
          done || echo "  No NAND bundles found"
        fi

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: seedsigner-luckfox-pico-${{ matrix.hardware }}-${{ matrix.boot }}-${{ github.run_number }}
        path: |
          build-artifacts/*.img
          build-artifacts/*.tar.gz
        retention-days: 30
        if-no-files-found: warn
    
    - name: Build summary
      if: always()
      run: |
        echo "## ðŸŽ¯ SeedSigner Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Hardware**: ${{ matrix.hardware }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Boot Medium**: ${{ matrix.boot }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Run Number**: ${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
        
        # Find SD card images
        SD_IMAGES=$(find build-artifacts -name "*.img" -type f 2>/dev/null || true)
        NAND_BUNDLES=$(find build-artifacts -name "*-nand-bundle-*.tar.gz" -type f 2>/dev/null || true)
        
        if [ -n "$SD_IMAGES" ]; then
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ’¾ SD Card Images (Ready to Flash)" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "$SD_IMAGES" | while IFS= read -r f; do
            echo "$(basename "$f") - $(du -sh "$f" | cut -f1)"
          done >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**How to Flash SD Card:**" >> $GITHUB_STEP_SUMMARY
          echo "1. Download the artifact from this build" >> $GITHUB_STEP_SUMMARY
          echo "2. Extract the .img file" >> $GITHUB_STEP_SUMMARY
          echo "3. Flash to SD card using one of these methods:" >> $GITHUB_STEP_SUMMARY
          echo "   - Raspberry Pi Imager (easiest)" >> $GITHUB_STEP_SUMMARY
          echo "   - \`dd\` command: \`sudo dd bs=4M status=progress if=<downloaded-image.img> of=/dev/sdX\`" >> $GITHUB_STEP_SUMMARY
          echo "     (Replace \`<downloaded-image.img>\` with actual filename and \`/dev/sdX\` with your SD card device)" >> $GITHUB_STEP_SUMMARY
          echo "4. Insert SD card into LuckFox Pico device and boot!" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ -n "$NAND_BUNDLES" ]; then
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ NAND Flash Bundles" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "$NAND_BUNDLES" | while IFS= read -r f; do
            echo "$(basename "$f") - $(du -sh "$f" | cut -f1)"
          done >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**How to Flash NAND:**" >> $GITHUB_STEP_SUMMARY
          echo "1. Download and extract the NAND bundle (.tar.gz file)" >> $GITHUB_STEP_SUMMARY
          echo "2. Use official LuckFox/Rockchip upgrade tools with \`update.img\`, or" >> $GITHUB_STEP_SUMMARY
          echo "3. Use U-Boot workflows with \`sd_update.txt\` or \`tftp_update.txt\`" >> $GITHUB_STEP_SUMMARY
          echo "4. See [LuckFox Official Flashing Guide](https://wiki.luckfox.com/Luckfox-Pico/Linux-MacOS-Burn-Image/)" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ -z "$SD_IMAGES" ] && [ -z "$NAND_BUNDLES" ]; then
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âŒ **No build artifacts found**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The build may have failed. Check the build logs above." >> $GITHUB_STEP_SUMMARY
        fi

name: Build SeedSigner OS

on:
  push:
    branches: [ main, develop, master ]
  pull_request:
    branches: [ main, develop, master ]
  workflow_dispatch:
    inputs:
      force_rebuild:
        description: 'Force rebuild Docker image'
        required: false
        default: false
        type: boolean
      build_mini:
        description: 'Build Mini target'
        required: false
        default: true
        type: boolean
      build_max:
        description: 'Build Max target'
        required: false
        default: true
        type: boolean
      build_microsd:
        description: 'Build MicroSD artifacts'
        required: false
        default: true
        type: boolean
      build_nand:
        description: 'Build NAND artifacts'
        required: false
        default: true
        type: boolean
      luckfox_pico_ref:
        description: 'Pin luckfox-pico ref (branch/tag/SHA); leave blank for default clone behavior'
        required: false
        default: ''
        type: string
      seedsigner_os_ref:
        description: 'Pin seedsigner-os ref (branch/tag/SHA); leave blank for default clone behavior'
        required: false
        default: ''
        type: string
      seedsigner_ref:
        description: 'Pin seedsigner ref (branch/tag/SHA); leave blank for default clone behavior'
        required: false
        default: ''
        type: string

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 240

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          lfs: true
          submodules: recursive


      - name: Diagnose Git LFS content
        run: |
          git lfs ls-files || true
          git lfs status || true
          rg -n "git-lfs.github.com/spec" . || true
      - name: Free disk space for large image builds
        run: |
          df -h
          sudo rm -rf /usr/share/dotnet /opt/ghc /usr/local/lib/android /opt/hostedtoolcache || true
          docker system prune -af || true
          df -h

      - name: Build system status
        run: |
          cd buildroot
          ./build.sh status

      - name: Build SeedSigner OS
        run: |
          cd buildroot
          echo "üöÄ Starting SeedSigner build..."

          BUILD_MINI=true
          BUILD_MAX=true
          BUILD_MICROSD=true
          BUILD_NAND=true

          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            BUILD_MINI="${{ github.event.inputs.build_mini }}"
            BUILD_MAX="${{ github.event.inputs.build_max }}"
            BUILD_MICROSD="${{ github.event.inputs.build_microsd }}"
            BUILD_NAND="${{ github.event.inputs.build_nand }}"
          fi

          MODELS=()
          if [ "$BUILD_MINI" = "true" ]; then MODELS+=(mini); fi
          if [ "$BUILD_MAX" = "true" ]; then MODELS+=(max); fi

          ARTIFACT_FLAGS=()
          if [ "$BUILD_MICROSD" = "true" ]; then ARTIFACT_FLAGS+=(--microsd); fi
          if [ "$BUILD_NAND" = "true" ]; then ARTIFACT_FLAGS+=(--nand); fi

          if [ ${#MODELS[@]} -eq 0 ]; then
            echo "‚ùå No models selected. Enable at least one of: build_mini, build_max"
            exit 1
          fi

          if [ ${#ARTIFACT_FLAGS[@]} -eq 0 ]; then
            echo "‚ùå No artifact types selected. Enable at least one of: build_microsd, build_nand"
            exit 1
          fi

          BASE_ARGS=(build --output ../build-artifacts)
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ "${{ github.event.inputs.force_rebuild }}" = "true" ]; then
            BASE_ARGS+=(--force)
          fi

          # Optional upstream ref pinning for deterministic CI builds.
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            export LUCKFOX_PICO_REF="${{ github.event.inputs.luckfox_pico_ref }}"
            export SEEDSIGNER_OS_REF="${{ github.event.inputs.seedsigner_os_ref }}"
            export SEEDSIGNER_REF="${{ github.event.inputs.seedsigner_ref }}"
          fi

          echo "Ref pins: LUCKFOX_PICO_REF='${LUCKFOX_PICO_REF:-}', SEEDSIGNER_OS_REF='${SEEDSIGNER_OS_REF:-}', SEEDSIGNER_REF='${SEEDSIGNER_REF:-}'"

          for model in "${MODELS[@]}"; do
            BUILD_ARGS=("${BASE_ARGS[@]}" --model "$model" "${ARTIFACT_FLAGS[@]}")
            echo "Running: ./build.sh ${BUILD_ARGS[*]}"
            ./build.sh "${BUILD_ARGS[@]}"
          done

      - name: Verify generated artifacts are not obviously corrupt
        if: always()
        run: |
          set -e

          BUILD_MICROSD=true
          BUILD_NAND=true
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            BUILD_MICROSD="${{ github.event.inputs.build_microsd }}"
            BUILD_NAND="${{ github.event.inputs.build_nand }}"
          fi

          if [ "$BUILD_MICROSD" = "true" ]; then
            found_img=0
            while IFS= read -r -d '' img; do
              found_img=1
              size=$(stat -c '%s' "$img")
              echo "Checking $img ($size bytes)"
              if [ "$size" -lt 104857600 ]; then
                echo "‚ùå Image too small: $img"
                exit 1
              fi
              file "$img"
            done < <(find build-artifacts -name 'seedsigner-luckfox-pico*.img' -type f -print0)

            if [ "$found_img" -eq 0 ]; then
              echo "‚ùå MicroSD build requested but no seedsigner-luckfox-pico*.img artifacts found"
              exit 1
            fi
          else
            echo "Skipping .img validation (MicroSD build not requested)"
          fi

          if [ "$BUILD_NAND" = "true" ]; then
            found_nand=0
            while IFS= read -r -d '' f; do
              found_nand=1
              echo "Found NAND artifact: $f"
            done < <(find build-artifacts \( -name 'seedsigner-luckfox-pico*-nand-bundle*.tar.gz' -o -name 'seedsigner-luckfox-pico-*-nand-files-*' -o -name 'seedsigner-luckfox-pico-*-nand-sdk-images-*.tar.gz' \) -print0)

            if [ "$found_nand" -eq 0 ]; then
              echo "‚ùå NAND build requested but no NAND artifacts found"
              exit 1
            fi
          else
            echo "Skipping NAND validation (NAND build not requested)"
          fi

      - name: List build artifacts
        if: always()
        run: |
          echo "üéØ Build artifacts:"
          ls -la build-artifacts/ || echo "No build artifacts found"

          echo ""
          echo "üîç Images:"
          find build-artifacts -name "seedsigner-luckfox-pico*.img" -type f 2>/dev/null || echo "No images found"

          echo ""
          echo "üìä Image sizes:"
          find build-artifacts -name "seedsigner-luckfox-pico*.img" -exec du -sh {} \; 2>/dev/null || echo "No images to measure"

          echo ""
          echo "üì¶ NAND bundle zips:"
          find build-artifacts -name "seedsigner-luckfox-pico-*-nand-bundle.zip" -type f 2>/dev/null || echo "No NAND bundle zips found"

          echo ""
          echo "üóúÔ∏è NAND bundle tar.gz files:"
          find build-artifacts -name "seedsigner-luckfox-pico*.tar.gz" -type f 2>/dev/null || echo "No NAND bundle tar.gz files found"

      - name: Package NAND bundle zips
        if: always()
        run: |
          mkdir -p build-artifacts
          shopt -s nullglob

          BUNDLES=(build-artifacts/seedsigner-luckfox-pico-*-nand-files-*)
          if [ ${#BUNDLES[@]} -eq 0 ]; then
            echo "No NAND bundle folders found"
          else
            for bundle_dir in "${BUNDLES[@]}"; do
              [ -d "$bundle_dir" ] || continue
              bundle_name=$(basename "$bundle_dir")

              hw_target="unknown"
              if [[ "$bundle_name" =~ seedsigner-luckfox-pico-([^-]+)-nand-files- ]]; then
                hw_target="${BASH_REMATCH[1]}"
              fi

              zip_name="seedsigner-luckfox-pico-${hw_target}-nand-bundle.zip"
              echo "Creating NAND zip: $zip_name from $bundle_name"

              rm -f "build-artifacts/$zip_name"
              (cd build-artifacts && zip -qr "$zip_name" "$bundle_name")
            done
          fi

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: seedsigner-os-${{ github.run_number }}
          path: |
            build-artifacts/seedsigner-luckfox-pico*.img
            build-artifacts/seedsigner-luckfox-pico-*-nand-bundle.zip
            build-artifacts/seedsigner-luckfox-pico*.tar.gz
            build-artifacts/debug-*/**
          retention-days: 30
          if-no-files-found: warn

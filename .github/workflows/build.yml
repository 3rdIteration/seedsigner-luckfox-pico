name: Build SeedSigner OS

on:
  push:
    branches: [main, develop, master]
  pull_request:
    branches: [main, develop, master]
  workflow_dispatch:
    inputs:
      force_rebuild:
        description: Force rebuild Docker image
        required: false
        default: false
        type: boolean
      medium:
        description: Medium to build (default NAND)
        required: false
        default: nand
        type: choice
        options: [nand, sd, all]

jobs:
  build:
    name: build-${{ matrix.profile }}-${{ matrix.medium }}
    runs-on: ubuntu-latest
    timeout-minutes: 180
    strategy:
      fail-fast: false
      matrix:
        profile: [mini, max]
        medium: [nand, sd]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build system status
        run: |
          cd buildroot
          ./build.sh status

      - name: Build variant
        if: ${{ github.event_name != 'workflow_dispatch' || github.event.inputs.medium == 'all' || github.event.inputs.medium == matrix.medium }}
        env:
          FORCE_REBUILDROOT_CONFIG: "1"
          PROFILE: ${{ matrix.profile }}
          MEDIUM: ${{ matrix.medium }}
        run: |
          set -euo pipefail
          cd buildroot
          VARIANT_DIR="../build-artifacts/${PROFILE}-${MEDIUM}"
          mkdir -p "$VARIANT_DIR"

          BUILD_ARGS=""
          if [ "${{ github.event.inputs.force_rebuild || 'false' }}" = "true" ]; then
            BUILD_ARGS="--force"
          fi

          if [ "$MEDIUM" = "nand" ]; then
            ./build.sh build $BUILD_ARGS --nand --model "$PROFILE" --output "$VARIANT_DIR"
          else
            ./build.sh build $BUILD_ARGS --microsd --model "$PROFILE" --output "$VARIANT_DIR"
          fi

      - name: Show exported debug summary
        if: ${{ always() && (github.event_name != 'workflow_dispatch' || github.event.inputs.medium == 'all' || github.event.inputs.medium == matrix.medium) }}
        env:
          PROFILE: ${{ matrix.profile }}
          MEDIUM: ${{ matrix.medium }}
        run: |
          set -euo pipefail
          VARIANT_DIR="$GITHUB_WORKSPACE/build-artifacts/${PROFILE}-${MEDIUM}"
          ls -la "$VARIANT_DIR" || true
          echo "=== buildroot.config.grep.txt ==="
          cat "$VARIANT_DIR/buildroot.config.grep.txt" || true
          echo "=== rootfs.selected.txt ==="
          cat "$VARIANT_DIR/rootfs.selected.txt" || true
          echo "=== images.report.txt (head) ==="
          head -200 "$VARIANT_DIR/images.report.txt" || true

      - name: Verify NAND rootfs export
        if: ${{ (github.event_name != 'workflow_dispatch' || github.event.inputs.medium == 'all' || github.event.inputs.medium == matrix.medium) && matrix.medium == 'nand' }}
        env:
          PROFILE: ${{ matrix.profile }}
          MEDIUM: ${{ matrix.medium }}
        run: |
          set -euo pipefail
          ROOTFS_IMG="$GITHUB_WORKSPACE/build-artifacts/${PROFILE}-${MEDIUM}/rootfs.img"
          test -f "$ROOTFS_IMG" || { echo "No exported NAND rootfs.img found at $ROOTFS_IMG"; exit 1; }
          file "$ROOTFS_IMG"
          if ! file "$ROOTFS_IMG" | grep -qi 'UBI image'; then
            echo "Exported NAND rootfs.img is not a UBI image"
            exit 1
          fi
          sha256sum "$ROOTFS_IMG"
          echo "ROOTFS_IMG=$ROOTFS_IMG" >> "$GITHUB_ENV"

      - name: Install ubi-reader
        if: ${{ (github.event_name != 'workflow_dispatch' || github.event.inputs.medium == 'all' || github.event.inputs.medium == matrix.medium) && matrix.medium == 'nand' }}
        run: python3 -m pip install --user ubi-reader

      - name: Rootfs UBI sanity check (NAND only)
        if: ${{ (github.event_name != 'workflow_dispatch' || github.event.inputs.medium == 'all' || github.event.inputs.medium == matrix.medium) && matrix.medium == 'nand' }}
        env:
          PROFILE: ${{ matrix.profile }}
          MEDIUM: ${{ matrix.medium }}
        run: |
          set -euo pipefail
          OUTDIR="$GITHUB_WORKSPACE/rootfs_sanity/${PROFILE}-${MEDIUM}"
          mkdir -p "$OUTDIR"
          python3 "$GITHUB_WORKSPACE/.github/scripts/check_rootfs_ubi.py" \
            --rootfs-img "$ROOTFS_IMG" \
            --outdir "$OUTDIR" \
            --workspace "$GITHUB_WORKSPACE"

      - name: Upload rootfs sanity report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: rootfs-sanity-${{ matrix.profile }}-${{ matrix.medium }}-${{ github.run_id }}
          path: rootfs_sanity/${{ matrix.profile }}-${{ matrix.medium }}/**
          retention-days: 30
          if-no-files-found: warn

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: seedsigner-os-${{ matrix.profile }}-${{ matrix.medium }}-${{ github.run_id }}
          path: |
            build-artifacts/${{ matrix.profile }}-${{ matrix.medium }}/**
          retention-days: 30
          if-no-files-found: warn

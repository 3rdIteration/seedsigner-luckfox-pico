name: Build SeedSigner OS

on:
  push:
    branches: [ main, develop, master ]
  pull_request:
    branches: [ main, develop, master ]
  workflow_dispatch:
    inputs:
      force_rebuild:
        description: 'Force rebuild Docker image'
        required: false
        default: false
        type: boolean
      medium:
        description: 'Build medium selection for manual runs'
        required: false
        default: nand
        type: choice
        options:
          - nand
          - sd
          - all

jobs:
  build:
    name: Build ${{ matrix.profile }}-${{ matrix.medium }}
    runs-on: ubuntu-latest
    timeout-minutes: 180
    strategy:
      fail-fast: false
      matrix:
        profile: [mini, max]
        medium: ${{ fromJson(github.event_name == 'workflow_dispatch' && github.event.inputs.medium != 'all' && format('["{0}"]', github.event.inputs.medium) || '["nand","sd"]') }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build system status
        run: |
          cd buildroot
          ./build.sh status

      - name: Show selected matrix variant
        run: |
          echo "event=${{ github.event_name }}"
          echo "workflow_dispatch.medium=${{ github.event.inputs.medium || 'n/a' }}"
          echo "profile=${{ matrix.profile }}"
          echo "medium=${{ matrix.medium }}"

      - name: Build variant
        run: |
          set -euo pipefail
          cd buildroot
          echo "ðŸš€ Starting SeedSigner build for profile=${{ matrix.profile }} medium=${{ matrix.medium }}"

          BUILD_ARGS=""
          if [ "${{ github.event.inputs.force_rebuild || 'false' }}" = "true" ]; then
            BUILD_ARGS="--force"
          fi

          VARIANT_DIR="$GITHUB_WORKSPACE/build-artifacts/${{ matrix.profile }}-${{ matrix.medium }}"
          mkdir -p "$VARIANT_DIR"

          if [ "${{ matrix.medium }}" = "nand" ]; then
            ./build.sh build $BUILD_ARGS --nand --model "${{ matrix.profile }}" --output "$VARIANT_DIR"
          else
            ./build.sh build $BUILD_ARGS --microsd --model "${{ matrix.profile }}" --output "$VARIANT_DIR"
          fi

      - name: Package NAND bundle zip
        if: always() && matrix.medium == 'nand'
        run: |
          set -euo pipefail
          VARIANT_DIR="$GITHUB_WORKSPACE/build-artifacts/${{ matrix.profile }}-${{ matrix.medium }}"
          shopt -s nullglob
          BUNDLES=("$VARIANT_DIR"/seedsigner-luckfox-pico-*-nand-files-*)
          for bundle_dir in "${BUNDLES[@]}"; do
            [ -d "$bundle_dir" ] || continue
            bundle_name=$(basename "$bundle_dir")
            zip_name="seedsigner-luckfox-pico-${{ matrix.profile }}-nand-bundle.zip"
            rm -f "$VARIANT_DIR/$zip_name"
            (cd "$VARIANT_DIR" && zip -qr "$zip_name" "$bundle_name")
            echo "Created $VARIANT_DIR/$zip_name"
          done

      - name: Collect debug bundle from build context
        if: always()
        run: |
          set -euo pipefail
          ARTIFACT_DIR="$GITHUB_WORKSPACE/build-artifacts/${{ matrix.profile }}-${{ matrix.medium }}"
          .github/scripts/collect_debug.sh "${{ matrix.profile }}" "${{ matrix.medium }}" "$ARTIFACT_DIR" "$GITHUB_WORKSPACE"
          echo "--- selected_rootfs_report.txt ---"
          cat "$ARTIFACT_DIR/selected_rootfs_report.txt" || true

      - name: NAND rootfs UBI sanity check
        if: matrix.medium == 'nand'
        run: |
          set -euo pipefail
          python3 -m pip install --user ubi-reader

          VARIANT_DIR="$GITHUB_WORKSPACE/build-artifacts/${{ matrix.profile }}-${{ matrix.medium }}"
          ROOTFS_IMG="$VARIANT_DIR/rootfs.img"
          if [ -z "$ROOTFS_IMG" ] || [ ! -f "$ROOTFS_IMG" ]; then
            echo "ERROR: Exported NAND rootfs image missing at $ROOTFS_IMG"
            exit 1
          fi

          if ! file "$ROOTFS_IMG" | grep -qi 'UBI image'; then
            echo "ERROR: Exported NAND rootfs is not a UBI image: $ROOTFS_IMG"
            file "$ROOTFS_IMG" || true
            exit 1
          fi

          echo "Selected NAND ROOTFS_IMG=$ROOTFS_IMG"
          file "$ROOTFS_IMG" || true

          OUTDIR="$GITHUB_WORKSPACE/rootfs_sanity/${{ matrix.profile }}-${{ matrix.medium }}"
          mkdir -p "$OUTDIR"
          python3 .github/scripts/check_rootfs_ubi.py --rootfs-img "$ROOTFS_IMG" --outdir "$OUTDIR" --workspace "$GITHUB_WORKSPACE"

      - name: SD sanity note
        if: matrix.medium == 'sd'
        run: |
          echo "Skipping UBI extraction sanity check for SD medium."

      - name: Upload rootfs sanity report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: rootfs-sanity-${{ matrix.profile }}-${{ matrix.medium }}-${{ github.run_id }}
          path: rootfs_sanity/${{ matrix.profile }}-${{ matrix.medium }}/**
          if-no-files-found: warn

      - name: Upload build/debug artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: seedsigner-${{ matrix.profile }}-${{ matrix.medium }}-${{ github.run_number }}
          path: |
            build-artifacts/${{ matrix.profile }}-${{ matrix.medium }}/**
          retention-days: 30
          if-no-files-found: warn

      - name: Build summary
        if: always()
        run: |
          VARIANT_DIR="$GITHUB_WORKSPACE/build-artifacts/${{ matrix.profile }}-${{ matrix.medium }}"
          echo "## ðŸŽ¯ SeedSigner Build Summary (${{ matrix.profile }} / ${{ matrix.medium }})" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Status**: ${{ job.status }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Commit**: ${{ github.sha }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Variant dir**: $VARIANT_DIR" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "### Images" >> "$GITHUB_STEP_SUMMARY"
          echo '```' >> "$GITHUB_STEP_SUMMARY"
          find "$VARIANT_DIR" -type f -name '*.img' 2>/dev/null | sed "s|$VARIANT_DIR/||" >> "$GITHUB_STEP_SUMMARY" || true
          echo '```' >> "$GITHUB_STEP_SUMMARY"

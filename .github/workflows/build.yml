name: Build SeedSigner OS

on:
  push:
    branches: [ main, develop, master ]
  pull_request:
    branches: [ main, develop, master ]
  workflow_dispatch:
    inputs:
      hardware_target:
        description: 'Hardware Target'
        required: true
        type: choice
        options:
          - both
          - mini
          - max
        default: 'both'
      build_artifacts:
        description: 'Build Artifacts'
        required: true
        type: choice
        options:
          - sd-and-nand
          - sd-only
          - nand-only
        default: 'sd-and-nand'
      force_rebuild:
        description: 'Force rebuild Docker image'
        required: false
        default: false
        type: boolean

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 180  # 3 hours max
    permissions:
      contents: read
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Free up disk space
      run: |
        # Remove unnecessary packages to free up space
        sudo apt-get clean
        sudo rm -rf /usr/share/dotnet
        sudo rm -rf /opt/ghc
        sudo rm -rf /usr/local/share/boost
        df -h

    - name: Set build parameters
      id: build-params
      run: |
        # Determine hardware target
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          HARDWARE_TARGET="${{ github.event.inputs.hardware_target }}"
          BUILD_TYPE="${{ github.event.inputs.build_artifacts }}"
          FORCE_REBUILD="${{ github.event.inputs.force_rebuild }}"
        else
          # Default for push/PR events
          HARDWARE_TARGET="both"
          BUILD_TYPE="sd-and-nand"
          FORCE_REBUILD="false"
        fi
        
        echo "hardware_target=${HARDWARE_TARGET}" >> $GITHUB_OUTPUT
        echo "build_type=${BUILD_TYPE}" >> $GITHUB_OUTPUT
        echo "force_rebuild=${FORCE_REBUILD}" >> $GITHUB_OUTPUT
        
        echo "::notice::Hardware Target: ${HARDWARE_TARGET}"
        echo "::notice::Build Type: ${BUILD_TYPE}"
        echo "::notice::Force Rebuild: ${FORCE_REBUILD}"

    - name: Build SeedSigner OS
      run: |
        cd buildroot
        
        echo "ðŸš€ Starting SeedSigner build..."
        echo "   Hardware: ${{ steps.build-params.outputs.hardware_target }}"
        echo "   Artifacts: ${{ steps.build-params.outputs.build_type }}"
        echo "   Force rebuild: ${{ steps.build-params.outputs.force_rebuild }}"
        
        # Set build options
        BUILD_ARGS=""
        if [ "${{ steps.build-params.outputs.force_rebuild }}" = "true" ]; then
          BUILD_ARGS="$BUILD_ARGS --force"
        fi
        
        BUILD_ARGS="$BUILD_ARGS --model ${{ steps.build-params.outputs.hardware_target }}"
        BUILD_ARGS="$BUILD_ARGS --output ../build-artifacts"
        
        # Determine which artifacts to build
        case "${{ steps.build-params.outputs.build_type }}" in
          sd-and-nand)
            BUILD_ARGS="$BUILD_ARGS --microsd --nand"
            ;;
          sd-only)
            BUILD_ARGS="$BUILD_ARGS --microsd"
            ;;
          nand-only)
            BUILD_ARGS="$BUILD_ARGS --nand"
            ;;
        esac
        
        # Run the build
        ./build.sh build $BUILD_ARGS
    
    - name: List build artifacts
      if: always()
      run: |
        echo "ðŸŽ¯ Build artifacts:"
        ls -lah build-artifacts/ 2>/dev/null || echo "No build artifacts directory found"
        
        echo ""
        echo "ðŸ” SD Card Images:"
        find build-artifacts -name "seedsigner-luckfox-pico*-sd-*.img" -type f 2>/dev/null | while IFS= read -r f; do
          echo "  $(basename "$f") - $(du -sh "$f" | cut -f1)"
        done || echo "  No SD images found"
        
        echo ""
        echo "ðŸ“¦ NAND Bundle Archives:"
        find build-artifacts -name "seedsigner-luckfox-pico*-nand-bundle-*.tar.gz" -type f 2>/dev/null | while IFS= read -r f; do
          echo "  $(basename "$f") - $(du -sh "$f" | cut -f1)"
        done || echo "  No NAND bundles found"

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: seedsigner-luckfox-pico-${{ steps.build-params.outputs.hardware_target }}-${{ github.run_number }}
        path: |
          build-artifacts/seedsigner-luckfox-pico*.img
          build-artifacts/seedsigner-luckfox-pico*.tar.gz
        retention-days: 30
        if-no-files-found: warn
    
    - name: Build summary
      if: always()
      run: |
        echo "## ðŸŽ¯ SeedSigner Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Hardware Target**: ${{ steps.build-params.outputs.hardware_target }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Build Type**: ${{ steps.build-params.outputs.build_type }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Run Number**: ${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
        
        # Find SD card images
        SD_IMAGES=$(find build-artifacts -name "seedsigner-luckfox-pico*-sd-*.img" -type f 2>/dev/null || true)
        if [ -n "$SD_IMAGES" ]; then
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ’¾ SD Card Images (Ready to Flash)" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "$SD_IMAGES" | while IFS= read -r f; do
            echo "$(basename "$f") - $(du -sh "$f" | cut -f1)"
          done >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**How to Flash SD Card:**" >> $GITHUB_STEP_SUMMARY
          echo "1. Download the artifact from this build" >> $GITHUB_STEP_SUMMARY
          echo "2. Extract the .img file" >> $GITHUB_STEP_SUMMARY
          echo "3. Flash to SD card using one of these methods:" >> $GITHUB_STEP_SUMMARY
          echo "   - Raspberry Pi Imager (easiest)" >> $GITHUB_STEP_SUMMARY
          echo "   - \`dd\` command: \`sudo dd bs=4M status=progress if=seedsigner-luckfox-pico-*.img of=/dev/sdX\`" >> $GITHUB_STEP_SUMMARY
          echo "4. Insert SD card into LuckFox Pico device and boot!" >> $GITHUB_STEP_SUMMARY
        fi
        
        # Find NAND bundles
        NAND_BUNDLES=$(find build-artifacts -name "seedsigner-luckfox-pico*-nand-bundle-*.tar.gz" -type f 2>/dev/null || true)
        if [ -n "$NAND_BUNDLES" ]; then
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ NAND Flash Bundles" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "$NAND_BUNDLES" | while IFS= read -r f; do
            echo "$(basename "$f") - $(du -sh "$f" | cut -f1)"
          done >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**How to Flash NAND:**" >> $GITHUB_STEP_SUMMARY
          echo "1. Download and extract the NAND bundle" >> $GITHUB_STEP_SUMMARY
          echo "2. Use official LuckFox/Rockchip upgrade tools with \`update.img\`, or" >> $GITHUB_STEP_SUMMARY
          echo "3. Use U-Boot workflows with \`sd_update.txt\` or \`tftp_update.txt\`" >> $GITHUB_STEP_SUMMARY
          echo "4. See [LuckFox Official Flashing Guide](https://wiki.luckfox.com/Luckfox-Pico/Linux-MacOS-Burn-Image/)" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ -z "$SD_IMAGES" ] && [ -z "$NAND_BUNDLES" ]; then
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âŒ **No build artifacts found**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The build may have failed. Check the build logs above." >> $GITHUB_STEP_SUMMARY
        fi

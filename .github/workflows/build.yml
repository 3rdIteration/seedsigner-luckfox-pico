name: Build SeedSigner OS

on:
  push:
    branches: [ main, develop, master ]
  pull_request:
    branches: [ main, develop, master ]
  workflow_dispatch:
    inputs:
      force_rebuild:
        description: 'Force rebuild Docker image'
        required: false
        default: false
        type: boolean
      profile:
        description: 'Profile selection'
        required: false
        default: 'all'
        type: choice
        options: [all, mini, max]
      medium:
        description: 'Boot medium selection'
        required: false
        default: 'nand'
        type: choice
        options: [all, nand, sd]
      luckfox_pico_ref:
        description: 'Pin luckfox-pico ref (branch/tag/SHA); leave blank for default clone behavior'
        required: false
        default: ''
        type: string
      seedsigner_os_ref:
        description: 'Pin seedsigner-os ref (branch/tag/SHA); leave blank for default clone behavior'
        required: false
        default: ''
        type: string
      seedsigner_ref:
        description: 'Pin seedsigner ref (branch/tag/SHA); leave blank for default clone behavior'
        required: false
        default: ''
        type: string

jobs:
  build-variant:
    name: build-${{ matrix.profile }}-${{ matrix.medium }}
    runs-on: ubuntu-latest
    timeout-minutes: 240
    strategy:
      fail-fast: false
      matrix:
        profile: [mini, max]
        medium: [sd, nand]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          lfs: true
          submodules: recursive

      - name: Select matrix variant for this run
        id: select
        run: |
          SELECTED=true
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            if [ "${{ github.event.inputs.profile }}" != "all" ] && [ "${{ github.event.inputs.profile }}" != "${{ matrix.profile }}" ]; then
              SELECTED=false
            fi
            if [ "${{ github.event.inputs.medium }}" != "all" ] && [ "${{ github.event.inputs.medium }}" != "${{ matrix.medium }}" ]; then
              SELECTED=false
            fi
          fi
          echo "selected=$SELECTED" >> "$GITHUB_OUTPUT"
          echo "Variant ${{ matrix.profile }}-${{ matrix.medium }} selected=$SELECTED"

      - name: Free disk space for large image builds
        if: ${{ steps.select.outputs.selected == 'true' }}
        run: |
          df -h
          sudo rm -rf /usr/share/dotnet /opt/ghc /usr/local/lib/android /opt/hostedtoolcache || true
          docker system prune -af || true
          df -h

      - name: Build SeedSigner OS (${{ matrix.profile }}-${{ matrix.medium }})
        if: ${{ steps.select.outputs.selected == 'true' }}
        run: |
          cd buildroot
          ARTIFACT_DIR="../build-artifacts/${{ matrix.profile }}-${{ matrix.medium }}"
          mkdir -p "$ARTIFACT_DIR"

          BUILD_ARGS=(build --output "$ARTIFACT_DIR" --model "${{ matrix.profile }}")
          if [ "${{ matrix.medium }}" = "nand" ]; then
            BUILD_ARGS+=(--nand)
          else
            BUILD_ARGS+=(--microsd)
          fi

          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ "${{ github.event.inputs.force_rebuild }}" = "true" ]; then
            BUILD_ARGS+=(--force)
          fi

          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            export LUCKFOX_PICO_REF="${{ github.event.inputs.luckfox_pico_ref }}"
            export SEEDSIGNER_OS_REF="${{ github.event.inputs.seedsigner_os_ref }}"
            export SEEDSIGNER_REF="${{ github.event.inputs.seedsigner_ref }}"
          fi

          echo "Variant: profile=${{ matrix.profile }} medium=${{ matrix.medium }}"
          echo "Running: ./build.sh ${BUILD_ARGS[*]}"
          ./build.sh "${BUILD_ARGS[@]}"

      - name: Debug Buildroot env/config/git from workspace
        if: ${{ always() && steps.select.outputs.selected == 'true' }}
        run: |
          ARTIFACT_DIR="$GITHUB_WORKSPACE/build-artifacts/${{ matrix.profile }}-${{ matrix.medium }}"
          mkdir -p "$ARTIFACT_DIR"

          echo "=== BR2 env vars ===" | tee "$ARTIFACT_DIR/workspace-br2-env.txt"
          env | sort | grep -E '^(BR2_EXTERNAL|BR2_)' | tee -a "$ARTIFACT_DIR/workspace-br2-env.txt" || true

          CONFIG_FILES=$(find "$GITHUB_WORKSPACE" \( -path "*buildroot*/output*/.config" -o -path "*buildroot*/output*/build/.config" \) -type f 2>/dev/null || true)
          echo "$CONFIG_FILES" | tee "$ARTIFACT_DIR/workspace-config-paths.txt"

          {
            for f in $CONFIG_FILES; do
              echo "=== $f ==="
              grep -E '^(BR2_PACKAGE_EUDEV|BR2_PACKAGE_KMOD|BR2_PACKAGE_UTIL_LINUX|BR2_PACKAGE_UTIL_LINUX_LIBBLKID|BR2_PACKAGE_BUSYBOX|BR2_ROOTFS_OVERLAY|BR2_DEFCONFIG|BR2_EXTERNAL)=' "$f" || true
            done
          } | tee "$ARTIFACT_DIR/workspace-config-grep.txt"

          {
            echo "top_sha: $(git rev-parse HEAD 2>/dev/null || echo unknown)"
            echo "top_status:"
            git status --porcelain || true
            if [ -d "$GITHUB_WORKSPACE/buildroot" ]; then
              echo "buildroot_sha: $(cd "$GITHUB_WORKSPACE/buildroot" && git rev-parse HEAD 2>/dev/null || echo unknown)"
            fi
            if [ -d "$GITHUB_WORKSPACE/buildroot/build-output/luckfox_pico_sdk" ]; then
              echo "luckfox_sdk_sha: $(cd "$GITHUB_WORKSPACE/buildroot/build-output/luckfox_pico_sdk" && git rev-parse HEAD 2>/dev/null || echo unknown)"
              echo "luckfox_sdk_status:"
              (cd "$GITHUB_WORKSPACE/buildroot/build-output/luckfox_pico_sdk" && git status --porcelain) || true
            fi
          } | tee "$ARTIFACT_DIR/workspace-git.txt"


      - name: Debug exported container build artifacts
        if: ${{ always() && steps.select.outputs.selected == 'true' }}
        run: |
          ARTIFACT_DIR="$GITHUB_WORKSPACE/build-artifacts/${{ matrix.profile }}-${{ matrix.medium }}"

          echo "=== Exported buildroot config path ==="
          ls -l "$ARTIFACT_DIR/buildroot.config" || true

          echo "=== Exported buildroot key flags ==="
          cat "$ARTIFACT_DIR/buildroot.config.grep.txt" || true

          echo "=== Exported target rootfs manifest head ==="
          head -n 120 "$ARTIFACT_DIR/target.manifest.txt" || true

          echo "=== Exported image report ==="
          cat "$ARTIFACT_DIR/images.report.txt" || true

          echo "=== Exported selected rootfs ==="
          cat "$ARTIFACT_DIR/selected-rootfs.txt" || true

          echo "=== Exported git report ==="
          cat "$ARTIFACT_DIR/git.txt" || true

      - name: Locate NAND UBI rootfs image and log format
        if: ${{ always() && steps.select.outputs.selected == 'true' && matrix.medium == 'nand' }}
        run: |
          ARTIFACT_DIR="$GITHUB_WORKSPACE/build-artifacts/${{ matrix.profile }}-${{ matrix.medium }}"

          ROOTFS_IMG=$(find "$ARTIFACT_DIR" -type f -name "rootfs.img" -print0 | xargs -0 -I {} sh -c 'file "{}" | grep -qi "UBI image" && echo "{}"' | head -n 1)
          if [ -z "$ROOTFS_IMG" ]; then
            ROOTFS_IMG=$(find "$GITHUB_WORKSPACE" -type f -name "rootfs.img" -print0 | xargs -0 -I {} sh -c 'file "{}" | grep -qi "UBI image" && echo "{}"' | head -n 1)
          fi

          echo "ROOTFS_IMG=$ROOTFS_IMG" | tee "$ARTIFACT_DIR/selected-rootfs-from-workflow.txt"
          if [ -z "$ROOTFS_IMG" ]; then
            echo "❌ Could not locate a NAND UBI rootfs.img in artifacts/workspace" | tee -a "$ARTIFACT_DIR/selected-rootfs-from-workflow.txt"
            exit 1
          fi

          file "$ROOTFS_IMG" | tee -a "$ARTIFACT_DIR/selected-rootfs-from-workflow.txt"
          sha256sum "$ROOTFS_IMG" | tee -a "$ARTIFACT_DIR/selected-rootfs-from-workflow.txt"

      - name: Rootfs UBI sanity check (NAND only)
        if: ${{ steps.select.outputs.selected == 'true' && matrix.medium == 'nand' }}
        run: |
          python3 -m pip install --user ubi-reader
          ARTIFACT_DIR="$GITHUB_WORKSPACE/build-artifacts/${{ matrix.profile }}-${{ matrix.medium }}"
          SANITY_DIR="$GITHUB_WORKSPACE/rootfs_sanity/${{ matrix.profile }}-${{ matrix.medium }}"
          mkdir -p "$SANITY_DIR"

          ROOTFS_IMG=$(grep '^ROOTFS_IMG=' "$ARTIFACT_DIR/selected-rootfs-from-workflow.txt" | head -n 1 | cut -d'=' -f2-)
          echo "ROOTFS_IMG=$ROOTFS_IMG"
          if [ -z "$ROOTFS_IMG" ]; then
            echo "❌ Missing selected NAND UBI rootfs path"
            exit 1
          fi

          if ! file "$ROOTFS_IMG" | grep -qi 'UBI image'; then
            echo "❌ Selected rootfs is not UBI format: $ROOTFS_IMG"
            file "$ROOTFS_IMG" || true
            exit 1
          fi

          python3 .github/scripts/check_rootfs_ubi.py \
            --rootfs-img "$ROOTFS_IMG" \
            --outdir "$SANITY_DIR" \
            --workspace "$GITHUB_WORKSPACE"

      - name: Upload rootfs sanity report
        uses: actions/upload-artifact@v4
        if: ${{ always() && steps.select.outputs.selected == 'true' }}
        with:
          name: rootfs-sanity-${{ matrix.profile }}-${{ matrix.medium }}-${{ github.run_id }}
          path: rootfs_sanity/${{ matrix.profile }}-${{ matrix.medium }}/**
          if-no-files-found: ignore

      - name: Upload build and debug artifacts
        uses: actions/upload-artifact@v4
        if: ${{ always() && steps.select.outputs.selected == 'true' }}
        with:
          name: seedsigner-os-${{ matrix.profile }}-${{ matrix.medium }}-${{ github.run_id }}
          path: |
            build-artifacts/${{ matrix.profile }}-${{ matrix.medium }}/**
          retention-days: 30
          if-no-files-found: warn

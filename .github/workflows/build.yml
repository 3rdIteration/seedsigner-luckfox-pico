name: Build SeedSigner OS

on:
  push:
    branches: [ main, develop, master ]
  pull_request:
    branches: [ main, develop, master ]
  workflow_dispatch:
    inputs:
      force_rebuild:
        description: 'Force rebuild Docker image'
        required: false
        default: false
        type: boolean
      build_microsd:
        description: 'Build MicroSD artifacts'
        required: false
        default: false
        type: boolean
      build_nand:
        description: 'Build NAND artifacts'
        required: false
        default: true
        type: boolean
      build_mini:
        description: 'Build Mini hardware target'
        required: false
        default: true
        type: boolean
      build_max:
        description: 'Build Max hardware target'
        required: false
        default: false
        type: boolean
      luckfox_ref:
        description: 'Optional luckfox-pico git ref (branch/tag/commit)'
        required: false
        default: ''
        type: string
      seedsigner_ref:
        description: 'Optional seedsigner git ref (branch/tag/commit)'
        required: false
        default: ''
        type: string
      seedsigner_os_ref:
        description: 'Optional seedsigner-os git ref (branch/tag/commit)'
        required: false
        default: ''
        type: string

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 180  # 3 hours max
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build system status
      run: |
        cd buildroot
        ./build.sh status
    
    - name: Build SeedSigner OS
      run: |
        cd buildroot
        echo "ðŸš€ Starting SeedSigner build..."

        BUILD_ARGS=""

        # Default behavior mirrors local Docker builds:
        #   ./build.sh build --nand --model mini
        # This keeps CI artifacts aligned with known-good local output.
        BUILD_MICROSD=false
        BUILD_NAND=true
        BUILD_MINI=true
        BUILD_MAX=false

        # For manual runs, honor workflow_dispatch checkboxes
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          [ "${{ github.event.inputs.build_microsd }}" = "true" ] && BUILD_MICROSD=true || BUILD_MICROSD=false
          [ "${{ github.event.inputs.build_nand }}" = "true" ] && BUILD_NAND=true || BUILD_NAND=false
          [ "${{ github.event.inputs.build_mini }}" = "true" ] && BUILD_MINI=true || BUILD_MINI=false
          [ "${{ github.event.inputs.build_max }}" = "true" ] && BUILD_MAX=true || BUILD_MAX=false
        fi

        if [ "${{ github.event.inputs.force_rebuild }}" = "true" ]; then
          BUILD_ARGS="$BUILD_ARGS --force"
        fi

        # Build type flags
        if [ "$BUILD_MICROSD" = true ]; then
          BUILD_ARGS="$BUILD_ARGS --microsd"
        fi
        if [ "$BUILD_NAND" = true ]; then
          BUILD_ARGS="$BUILD_ARGS --nand"
        fi

        # Hardware target flag
        if [ "$BUILD_MINI" = true ] && [ "$BUILD_MAX" = true ]; then
          BUILD_MODEL="both"
        elif [ "$BUILD_MINI" = true ]; then
          BUILD_MODEL="mini"
        elif [ "$BUILD_MAX" = true ]; then
          BUILD_MODEL="max"
        else
          echo "âŒ Invalid selection: at least one hardware target must be selected"
          exit 1
        fi

        if [ "$BUILD_MICROSD" != true ] && [ "$BUILD_NAND" != true ]; then
          echo "âŒ Invalid selection: at least one build type must be selected"
          exit 1
        fi

        echo "Selected build types: microsd=$BUILD_MICROSD nand=$BUILD_NAND"
        echo "Selected hardware targets: mini=$BUILD_MINI max=$BUILD_MAX (model=$BUILD_MODEL)"
        echo "Equivalent local command: ./build.sh build $BUILD_ARGS --model $BUILD_MODEL"

        # Optional source pinning refs (useful for CI/local parity)
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          [ -n "${{ github.event.inputs.luckfox_ref }}" ] && export LUCKFOX_REF="${{ github.event.inputs.luckfox_ref }}"
          [ -n "${{ github.event.inputs.seedsigner_ref }}" ] && export SEEDSIGNER_REF="${{ github.event.inputs.seedsigner_ref }}"
          [ -n "${{ github.event.inputs.seedsigner_os_ref }}" ] && export SEEDSIGNER_OS_REF="${{ github.event.inputs.seedsigner_os_ref }}"
        fi

        # Run the build with artifact output to workspace
        ./build.sh build $BUILD_ARGS --model "$BUILD_MODEL" --output ../build-artifacts
    
    - name: List build artifacts
      if: always()
      run: |
        echo "ðŸŽ¯ Build artifacts:"
        ls -la build-artifacts/ || echo "No build artifacts found"
        
        echo ""
        echo "ðŸ” Searching for SeedSigner images:"
        find build-artifacts -name "seedsigner-luckfox-pico*.img" -type f 2>/dev/null || echo "No seedsigner-luckfox-pico images found"
        
        echo ""
        echo "ðŸ“Š Image sizes:"
        find build-artifacts -name "seedsigner-luckfox-pico*.img" -exec du -sh {} \; 2>/dev/null || echo "No images to measure"

        echo ""
        echo "ðŸ—œï¸ NAND bundle tar.gz files:"
        find build-artifacts -name "seedsigner-luckfox-pico*.tar.gz" -type f 2>/dev/null || echo "No NAND bundle tar.gz files found"

    - name: Validate NAND artifacts + create checksums
      if: always()
      run: |
        set -euo pipefail
        shopt -s nullglob

        tarballs=(build-artifacts/seedsigner-luckfox-pico-*-nand-bundle-*.tar.gz)
        if [ ${#tarballs[@]} -eq 0 ]; then
          echo "No NAND tarballs found for validation"
          exit 0
        fi

        tmpdir=$(mktemp -d)
        trap 'rm -rf "$tmpdir"' EXIT

        for tarball in "${tarballs[@]}"; do
          echo "Validating: $tarball"
          work="$tmpdir/$(basename "$tarball" .tar.gz)"
          mkdir -p "$work"
          tar -xzf "$tarball" -C "$work"

          sd_script=$(find "$work" -name sd_update.txt -type f | head -n 1 || true)
          tftp_script=$(find "$work" -name tftp_update.txt -type f | head -n 1 || true)

          if [ -z "$sd_script" ] || [ -z "$tftp_script" ]; then
            echo "Missing NAND update scripts in $tarball"
            exit 1
          fi

          if grep -q "mmc write" "$sd_script" "$tftp_script"; then
            echo "Invalid NAND script content (contains mmc write) in $tarball"
            exit 1
          fi

          if ! grep -q "mtd " "$sd_script" || ! grep -q "mtd " "$tftp_script"; then
            echo "Invalid NAND script content (missing mtd commands) in $tarball"
            exit 1
          fi
        done

        (cd build-artifacts && sha256sum seedsigner-luckfox-pico*.tar.gz > SHA256SUMS.txt)
        echo "Wrote build-artifacts/SHA256SUMS.txt"

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: seedsigner-os-${{ github.run_number }}
        path: |
          build-artifacts/seedsigner-luckfox-pico*.img
          build-artifacts/seedsigner-luckfox-pico-*-nand-files-*
          build-artifacts/seedsigner-luckfox-pico*.tar.gz
          build-artifacts/SHA256SUMS.txt
          build-artifacts/build-source-manifest.txt
        retention-days: 30
        if-no-files-found: warn
    
    - name: Build summary
      if: always()
      run: |
        echo "## ðŸŽ¯ SeedSigner Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "- **Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Run Number**: ${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        
        # Find and highlight seedsigner-luckfox-pico .img files specifically
        IMG_FILES=$(find build-artifacts -name "seedsigner-luckfox-pico*.img" 2>/dev/null || true)
        if [ -n "$IMG_FILES" ]; then
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŽ¯ Ready to Flash:" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "$IMG_FILES" | xargs -I {} basename {} >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          
          # Add flashing instructions
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ’¾ How to Use:" >> $GITHUB_STEP_SUMMARY
          echo "1. Download the artifact from this build" >> $GITHUB_STEP_SUMMARY
          echo "2. Extract the .img file" >> $GITHUB_STEP_SUMMARY
          echo "3. Flash to SD card using Raspberry Pi Imager or dd" >> $GITHUB_STEP_SUMMARY
          echo "4. Insert SD card into device and boot!" >> $GITHUB_STEP_SUMMARY
          
          # Show file size
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š Image Size:" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "$IMG_FILES" | xargs -I {} du -sh {} >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

          TAR_FILES=$(find build-artifacts -name "seedsigner-luckfox-pico*.tar.gz" 2>/dev/null || true)
          if [ -n "$TAR_FILES" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ—œï¸ NAND Bundle Tarballs:" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "$TAR_FILES" | xargs -I {} basename {} >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi

          if [ -f build-artifacts/SHA256SUMS.txt ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ” SHA256 Checksums:" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat build-artifacts/SHA256SUMS.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi

          if [ -f build-artifacts/build-source-manifest.txt ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ§¬ Source Manifest:" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat build-artifacts/build-source-manifest.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
        else
          echo "- **Image**: âŒ No seedsigner-luckfox-pico image found" >> $GITHUB_STEP_SUMMARY
        fi


  build_local_native:
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    timeout-minutes: 240

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install local build dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential curl git python3 python3-pip ssh make gcc \
          gcc-multilib g++-multilib module-assistant expect g++ gawk \
          texinfo libssl-dev bison flex fakeroot cmake unzip gperf autoconf \
          device-tree-compiler libncurses5-dev pkg-config bc python-is-python3 \
          passwd openssl openssh-server openssh-client vim file cpio rsync \
          ca-certificates

    - name: Build SeedSigner OS (local, non-Docker)
      run: |
        cd buildroot
        echo "ðŸš€ Starting local (non-Docker) SeedSigner build..."

        BUILD_MICROSD=false
        BUILD_NAND=true
        BUILD_MINI=true
        BUILD_MAX=false

        [ "${{ github.event.inputs.build_microsd }}" = "true" ] && BUILD_MICROSD=true || BUILD_MICROSD=false
        [ "${{ github.event.inputs.build_nand }}" = "true" ] && BUILD_NAND=true || BUILD_NAND=false
        [ "${{ github.event.inputs.build_mini }}" = "true" ] && BUILD_MINI=true || BUILD_MINI=false
        [ "${{ github.event.inputs.build_max }}" = "true" ] && BUILD_MAX=true || BUILD_MAX=false

        if [ "$BUILD_MINI" = true ] && [ "$BUILD_MAX" = true ]; then
          BUILD_MODEL="both"
        elif [ "$BUILD_MINI" = true ]; then
          BUILD_MODEL="mini"
        elif [ "$BUILD_MAX" = true ]; then
          BUILD_MODEL="max"
        else
          echo "âŒ Invalid selection: at least one hardware target must be selected"
          exit 1
        fi

        if [ "$BUILD_MICROSD" != true ] && [ "$BUILD_NAND" != true ]; then
          echo "âŒ Invalid selection: at least one build type must be selected"
          exit 1
        fi

        BUILD_MODE=""
        if [ "$BUILD_MICROSD" = true ] && [ "$BUILD_NAND" = true ]; then
          BUILD_MODE="auto-nand"
        elif [ "$BUILD_NAND" = true ]; then
          BUILD_MODE="auto-nand-only"
        else
          BUILD_MODE="auto"
        fi

        echo "Selected build types: microsd=$BUILD_MICROSD nand=$BUILD_NAND"
        echo "Selected hardware targets: mini=$BUILD_MINI max=$BUILD_MAX (model=$BUILD_MODEL)"
        echo "Equivalent local non-Docker command: BUILD_MODEL=$BUILD_MODEL ./os-build.sh $BUILD_MODE"

        export BUILD_MODEL="$BUILD_MODEL"
        export BUILD_DIR="$PWD"
        export OUTPUT_DIR="$GITHUB_WORKSPACE/build-artifacts-local"

        [ -n "${{ github.event.inputs.luckfox_ref }}" ] && export LUCKFOX_REF="${{ github.event.inputs.luckfox_ref }}"
        [ -n "${{ github.event.inputs.seedsigner_ref }}" ] && export SEEDSIGNER_REF="${{ github.event.inputs.seedsigner_ref }}"
        [ -n "${{ github.event.inputs.seedsigner_os_ref }}" ] && export SEEDSIGNER_OS_REF="${{ github.event.inputs.seedsigner_os_ref }}"

        ./os-build.sh "$BUILD_MODE"

    - name: List local build artifacts
      if: always()
      run: |
        echo "ðŸŽ¯ Local build artifacts:"
        ls -la build-artifacts-local/ || echo "No local build artifacts found"

        echo ""
        echo "ðŸ—œï¸ Local NAND bundle tar.gz files:"
        find build-artifacts-local -name "seedsigner-luckfox-pico*.tar.gz" -type f 2>/dev/null || echo "No local NAND bundle tar.gz files found"

    - name: Validate local NAND artifacts + create checksums
      if: always()
      run: |
        set -euo pipefail
        shopt -s nullglob

        tarballs=(build-artifacts-local/seedsigner-luckfox-pico-*-nand-bundle-*.tar.gz)
        if [ ${#tarballs[@]} -eq 0 ]; then
          echo "No local NAND tarballs found for validation"
          exit 0
        fi

        tmpdir=$(mktemp -d)
        trap 'rm -rf "$tmpdir"' EXIT

        for tarball in "${tarballs[@]}"; do
          echo "Validating: $tarball"
          work="$tmpdir/$(basename "$tarball" .tar.gz)"
          mkdir -p "$work"
          tar -xzf "$tarball" -C "$work"

          sd_script=$(find "$work" -name sd_update.txt -type f | head -n 1 || true)
          tftp_script=$(find "$work" -name tftp_update.txt -type f | head -n 1 || true)

          if [ -z "$sd_script" ] || [ -z "$tftp_script" ]; then
            echo "Missing NAND update scripts in $tarball"
            exit 1
          fi

          if grep -q "mmc write" "$sd_script" "$tftp_script"; then
            echo "Invalid NAND script content (contains mmc write) in $tarball"
            exit 1
          fi

          if ! grep -q "mtd " "$sd_script" || ! grep -q "mtd " "$tftp_script"; then
            echo "Invalid NAND script content (missing mtd commands) in $tarball"
            exit 1
          fi
        done

        (cd build-artifacts-local && sha256sum seedsigner-luckfox-pico*.tar.gz > SHA256SUMS.txt)
        echo "Wrote build-artifacts-local/SHA256SUMS.txt"

    - name: Upload local build artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: seedsigner-os-local-${{ github.run_number }}
        path: |
          build-artifacts-local/seedsigner-luckfox-pico*.img
          build-artifacts-local/seedsigner-luckfox-pico-*-nand-files-*
          build-artifacts-local/seedsigner-luckfox-pico*.tar.gz
          build-artifacts-local/SHA256SUMS.txt
          build-artifacts-local/build-source-manifest.txt
        retention-days: 30
        if-no-files-found: warn

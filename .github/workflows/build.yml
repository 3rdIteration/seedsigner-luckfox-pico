name: Build SeedSigner OS

on:
  push:
    branches: [ main, develop, master ]
  pull_request:
    branches: [ main, develop, master ]
  workflow_dispatch:
    inputs:
      force_rebuild:
        description: 'Force rebuild Docker image'
        required: false
        default: false
        type: boolean
      build_mini:
        description: 'Build Mini target'
        required: false
        default: true
        type: boolean
      build_max:
        description: 'Build Max target'
        required: false
        default: true
        type: boolean
      build_microsd:
        description: 'Build MicroSD artifacts'
        required: false
        default: true
        type: boolean
      build_nand:
        description: 'Build NAND artifacts'
        required: false
        default: true
        type: boolean

jobs:
  prepare-matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.matrix.outputs.matrix }}
      count: ${{ steps.matrix.outputs.count }}
    steps:
      - name: Build matrix from workflow inputs
        id: matrix
        run: |
          BUILD_MINI=true
          BUILD_MAX=true
          BUILD_MICROSD=true
          BUILD_NAND=true

          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            BUILD_MINI="${{ github.event.inputs.build_mini }}"
            BUILD_MAX="${{ github.event.inputs.build_max }}"
            BUILD_MICROSD="${{ github.event.inputs.build_microsd }}"
            BUILD_NAND="${{ github.event.inputs.build_nand }}"
          fi

          MODELS=()
          if [ "$BUILD_MINI" = "true" ]; then MODELS+=(mini); fi
          if [ "$BUILD_MAX" = "true" ]; then MODELS+=(max); fi

          TYPES=()
          if [ "$BUILD_MICROSD" = "true" ]; then TYPES+=(microsd); fi
          if [ "$BUILD_NAND" = "true" ]; then TYPES+=(nand); fi

          if [ ${#MODELS[@]} -eq 0 ] || [ ${#TYPES[@]} -eq 0 ]; then
            echo "matrix=[]" >> "$GITHUB_OUTPUT"
            echo "count=0" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          entries=()
          for model in "${MODELS[@]}"; do
            for artifact in "${TYPES[@]}"; do
              flag="--${artifact}"
              entries+=("{\"model\":\"${model}\",\"artifact\":\"${artifact}\",\"flag\":\"${flag}\"}")
            done
          done

          matrix_json="[$(IFS=,; echo "${entries[*]}")]"
          echo "matrix=${matrix_json}" >> "$GITHUB_OUTPUT"
          echo "count=${#entries[@]}" >> "$GITHUB_OUTPUT"

  build:
    needs: prepare-matrix
    if: ${{ needs.prepare-matrix.outputs.count != '0' }}
    runs-on: ubuntu-latest
    timeout-minutes: 180
    strategy:
      fail-fast: false
      matrix:
        build: ${{ fromJson(needs.prepare-matrix.outputs.matrix) }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build system status
        run: |
          cd buildroot
          ./build.sh status

      - name: Build SeedSigner OS
        run: |
          cd buildroot
          echo "üöÄ Starting SeedSigner build for model=${{ matrix.build.model }} artifact=${{ matrix.build.artifact }}"

          BUILD_ARGS=(build --output "../build-artifacts/${{ matrix.build.model }}-${{ matrix.build.artifact }}" --model "${{ matrix.build.model }}" "${{ matrix.build.flag }}")

          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ "${{ github.event.inputs.force_rebuild }}" = "true" ]; then
            BUILD_ARGS+=(--force)
          fi

          echo "Running: ./build.sh ${BUILD_ARGS[*]}"
          ./build.sh "${BUILD_ARGS[@]}"

      - name: Package NAND bundle zips
        if: ${{ matrix.build.artifact == 'nand' }}
        run: |
          ARTIFACT_DIR="build-artifacts/${{ matrix.build.model }}-${{ matrix.build.artifact }}"
          mkdir -p "$ARTIFACT_DIR"
          shopt -s nullglob

          BUNDLES=("$ARTIFACT_DIR"/seedsigner-luckfox-pico-*-nand-files-*)
          if [ ${#BUNDLES[@]} -eq 0 ]; then
            echo "No NAND bundle folders found"
          else
            for bundle_dir in "${BUNDLES[@]}"; do
              [ -d "$bundle_dir" ] || continue
              bundle_name=$(basename "$bundle_dir")

              hw_target="${{ matrix.build.model }}"
              zip_name="seedsigner-luckfox-pico-${hw_target}-nand-bundle.zip"
              echo "Creating NAND zip: $zip_name from $bundle_name"

              rm -f "$ARTIFACT_DIR/$zip_name"
              (cd "$ARTIFACT_DIR" && zip -qr "$zip_name" "$bundle_name")
            done
          fi

      - name: List build artifacts
        if: always()
        run: |
          ARTIFACT_DIR="build-artifacts/${{ matrix.build.model }}-${{ matrix.build.artifact }}"
          echo "üéØ Build artifacts in $ARTIFACT_DIR:"
          ls -la "$ARTIFACT_DIR" || echo "No build artifacts found"

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: seedsigner-os-${{ github.run_number }}-${{ matrix.build.model }}-${{ matrix.build.artifact }}
          path: |
            build-artifacts/${{ matrix.build.model }}-${{ matrix.build.artifact }}/seedsigner-luckfox-pico*.img
            build-artifacts/${{ matrix.build.model }}-${{ matrix.build.artifact }}/seedsigner-luckfox-pico-*-nand-bundle.zip
            build-artifacts/${{ matrix.build.model }}-${{ matrix.build.artifact }}/seedsigner-luckfox-pico*.tar.gz
          retention-days: 30
          if-no-files-found: warn

  no-build-selection:
    needs: prepare-matrix
    if: ${{ needs.prepare-matrix.outputs.count == '0' }}
    runs-on: ubuntu-latest
    steps:
      - name: Fail when nothing selected
        run: |
          echo "‚ùå No build targets selected. Enable at least one model and one artifact type."
          exit 1

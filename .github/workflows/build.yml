name: Build SeedSigner OS

on:
  push:
    branches: [ main, develop, master ]
  pull_request:
    branches: [ main, develop, master ]
  workflow_dispatch:
    inputs:
      force_rebuild:
        description: 'Force rebuild Docker image'
        required: false
        default: false
        type: boolean
      medium:
        description: 'Build medium selection for manual runs'
        required: false
        default: nand
        type: choice
        options:
          - nand
          - sd
          - all

jobs:
  build:
    name: build-${{ matrix.profile }}-${{ matrix.medium }}
    strategy:
      fail-fast: false
      matrix:
        profile: [mini, max]
        medium: [sd, nand]
    runs-on: ubuntu-latest
    timeout-minutes: 180

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Select variant for this run
      id: select_variant
      run: |
        if [ "${{ github.event_name }}" != "workflow_dispatch" ] || [ "${{ github.event.inputs.medium }}" = "all" ] || [ "${{ github.event.inputs.medium }}" = "${{ matrix.medium }}" ]; then
          echo "run_variant=true" >> "$GITHUB_OUTPUT"
        else
          echo "run_variant=false" >> "$GITHUB_OUTPUT"
        fi
        echo "run_variant=$(grep '^run_variant=' "$GITHUB_OUTPUT" | cut -d= -f2) for ${{ matrix.profile }}-${{ matrix.medium }}"

    - name: Build system status
      if: steps.select_variant.outputs.run_variant == 'true'
      run: |
        cd buildroot
        ./build.sh status

    - name: Build SeedSigner OS (${{ matrix.profile }} / ${{ matrix.medium }})
      if: steps.select_variant.outputs.run_variant == 'true'
      run: |
        set -euo pipefail
        cd buildroot
        echo "ðŸš€ Starting build for profile=${{ matrix.profile }} medium=${{ matrix.medium }}"

        BUILD_ARGS=""
        if [ "${{ github.event.inputs.force_rebuild }}" = "true" ]; then
          BUILD_ARGS="--force"
        fi

        VARIANT_DIR="../build-artifacts/${{ matrix.profile }}-${{ matrix.medium }}"
        mkdir -p "$VARIANT_DIR"

        if [ "${{ matrix.medium }}" = "nand" ]; then
          ./build.sh build $BUILD_ARGS --model ${{ matrix.profile }} --nand --output "$VARIANT_DIR"
        else
          ./build.sh build $BUILD_ARGS --model ${{ matrix.profile }} --microsd --output "$VARIANT_DIR"
        fi

    - name: Collect debug bundle from SDK/container build tree
      if: always() && steps.select_variant.outputs.run_variant == 'true'
      run: |
        set -euo pipefail
        mkdir -p "build-artifacts/${{ matrix.profile }}-${{ matrix.medium }}"
        ./.github/scripts/collect_debug.sh "${{ matrix.profile }}" "${{ matrix.medium }}" "$GITHUB_WORKSPACE/build-artifacts/${{ matrix.profile }}-${{ matrix.medium }}/debug"

    - name: Install rootfs sanity checker dependency
      if: steps.select_variant.outputs.run_variant == 'true' && matrix.medium == 'nand'
      run: |
        python3 -m pip install --user ubi-reader

    - name: Rootfs UBI sanity check (NAND only)
      if: steps.select_variant.outputs.run_variant == 'true' && matrix.medium == 'nand'
      run: |
        set -euo pipefail
        SANITY_DIR="$GITHUB_WORKSPACE/rootfs_sanity/${{ matrix.profile }}-${{ matrix.medium }}"
        mkdir -p "$SANITY_DIR"

        ROOTFS_IMG="$GITHUB_WORKSPACE/build-artifacts/${{ matrix.profile }}-${{ matrix.medium }}/debug/rootfs.img"
        if [ ! -f "$ROOTFS_IMG" ]; then
          ROOTFS_IMG=$(find "$GITHUB_WORKSPACE/build-artifacts/${{ matrix.profile }}-${{ matrix.medium }}" -type f -name "rootfs.img" | head -n 1 || true)
        fi

        echo "Selected NAND ROOTFS_IMG=$ROOTFS_IMG"
        if [ -z "$ROOTFS_IMG" ] || [ ! -f "$ROOTFS_IMG" ]; then
          echo "ERROR: Could not locate NAND rootfs.img for sanity check"
          exit 1
        fi

        file "$ROOTFS_IMG" || true
        python3 .github/scripts/check_rootfs_ubi.py --rootfs-img "$ROOTFS_IMG" --outdir "$SANITY_DIR" --workspace "$GITHUB_WORKSPACE"

    - name: Skip note for SD UBI sanity check
      if: steps.select_variant.outputs.run_variant == 'true' && matrix.medium == 'sd'
      run: |
        echo "Skipping UBI sanity check for SD build variant"

    - name: Upload rootfs sanity report
      uses: actions/upload-artifact@v4
      if: always() && steps.select_variant.outputs.run_variant == 'true'
      with:
        name: rootfs-sanity-${{ matrix.profile }}-${{ matrix.medium }}-${{ github.run_id }}
        path: rootfs_sanity/${{ matrix.profile }}-${{ matrix.medium }}/**
        if-no-files-found: warn

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      if: always() && steps.select_variant.outputs.run_variant == 'true'
      with:
        name: seedsigner-os-${{ matrix.profile }}-${{ matrix.medium }}-${{ github.run_number }}
        path: |
          build-artifacts/${{ matrix.profile }}-${{ matrix.medium }}/**
        retention-days: 30
        if-no-files-found: warn

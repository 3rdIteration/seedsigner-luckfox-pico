name: Build SeedSigner OS

on:
  push:
    branches: [ main, develop, master ]
  pull_request:
    branches: [ main, develop, master ]
  workflow_dispatch:
    inputs:
      force_rebuild:
        description: Force rebuild Docker image
        required: false
        default: false
        type: boolean
      medium:
        description: Medium to build (default NAND)
        required: false
        default: nand
        type: choice
        options:
          - nand
          - sd
          - all

jobs:
  build:
    name: build-${{ matrix.profile }}-${{ matrix.medium }}
    runs-on: ubuntu-latest
    timeout-minutes: 180
    if: ${{ github.event_name != 'workflow_dispatch' || github.event.inputs.medium == 'all' || github.event.inputs.medium == matrix.medium }}
    strategy:
      fail-fast: false
      matrix:
        profile: [mini, max]
        medium: [sd, nand]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build system status
        run: |
          cd buildroot
          ./build.sh status

      - name: Build variant
        env:
          FORCE_REBUILDROOT_CONFIG: "1"
          PROFILE: ${{ matrix.profile }}
          MEDIUM: ${{ matrix.medium }}
        run: |
          set -euo pipefail
          cd buildroot
          VARIANT_DIR="../build-artifacts/${PROFILE}-${MEDIUM}"
          mkdir -p "$VARIANT_DIR"

          BUILD_ARGS=""
          if [ "${{ github.event.inputs.force_rebuild || 'false' }}" = "true" ]; then
            BUILD_ARGS="--force"
          fi

          echo "ðŸš€ Building ${PROFILE}/${MEDIUM}"
          if [ "$MEDIUM" = "nand" ]; then
            ./build.sh build $BUILD_ARGS --nand --model "$PROFILE" --output "$VARIANT_DIR"
          else
            ./build.sh build $BUILD_ARGS --microsd --model "$PROFILE" --output "$VARIANT_DIR"
          fi

      - name: Post-build workspace debug
        if: always()
        env:
          PROFILE: ${{ matrix.profile }}
          MEDIUM: ${{ matrix.medium }}
        run: |
          set -euo pipefail
          VARIANT_DIR="$GITHUB_WORKSPACE/build-artifacts/${PROFILE}-${MEDIUM}"
          mkdir -p "$VARIANT_DIR"

          echo "ðŸ”§ BR2-related environment variables"
          env | sort | grep -E '^(BR2_EXTERNAL|BR2_)' | tee "$VARIANT_DIR/actions.env.txt" || true

          echo "ðŸ” Buildroot .config files in workspace"
          find "$GITHUB_WORKSPACE" \( -path "*buildroot*/output*/.config" -o -path "*buildroot*/output*/build/.config" \) -type f 2>/dev/null | tee "$VARIANT_DIR/actions.buildroot.config.paths.txt" || true

          echo "ðŸ§ª Key Buildroot config lines"
          while IFS= read -r cfg; do
            [ -n "$cfg" ] || continue
            echo "=== $cfg ===" | tee -a "$VARIANT_DIR/actions.buildroot.config.grep.txt"
            grep -E '^(BR2_PACKAGE_EUDEV|BR2_PACKAGE_KMOD|BR2_PACKAGE_UTIL_LINUX|BR2_PACKAGE_UTIL_LINUX_LIBBLKID|BR2_PACKAGE_BUSYBOX|BR2_ROOTFS_OVERLAY)=' "$cfg" | tee -a "$VARIANT_DIR/actions.buildroot.config.grep.txt" || true
          done < "$VARIANT_DIR/actions.buildroot.config.paths.txt"

          {
            echo "repo=$GITHUB_WORKSPACE"
            git rev-parse HEAD || true
            git status --porcelain || true
          } > "$VARIANT_DIR/actions.git.txt"

      - name: Locate NAND rootfs image
        if: ${{ matrix.medium == 'nand' }}
        env:
          PROFILE: ${{ matrix.profile }}
          MEDIUM: ${{ matrix.medium }}
        run: |
          set -euo pipefail
          VARIANT_DIR="$GITHUB_WORKSPACE/build-artifacts/${PROFILE}-${MEDIUM}"
          CANDIDATES=$(find "$VARIANT_DIR" -type f -name 'rootfs.img' 2>/dev/null || true)
          if [ -z "$CANDIDATES" ]; then
            CANDIDATES=$(find "$GITHUB_WORKSPACE" -type f -name 'rootfs.img' 2>/dev/null || true)
          fi

          ROOTFS_IMG=""
          while IFS= read -r img; do
            [ -n "$img" ] || continue
            if file "$img" | grep -qi 'UBI image'; then
              ROOTFS_IMG="$img"
              break
            fi
          done <<< "$CANDIDATES"

          if [ -z "$ROOTFS_IMG" ]; then
            echo "ERROR: could not find NAND UBI rootfs.img"
            echo "$CANDIDATES"
            exit 1
          fi

          echo "Selected NAND rootfs image: $ROOTFS_IMG"
          file "$ROOTFS_IMG"
          sha256sum "$ROOTFS_IMG"
          echo "ROOTFS_IMG=$ROOTFS_IMG" >> "$GITHUB_ENV"

      - name: Install ubi-reader
        if: ${{ matrix.medium == 'nand' }}
        run: python3 -m pip install --user ubi-reader

      - name: Rootfs UBI sanity check
        if: ${{ matrix.medium == 'nand' }}
        env:
          PROFILE: ${{ matrix.profile }}
          MEDIUM: ${{ matrix.medium }}
        run: |
          set -euo pipefail
          OUTDIR="$GITHUB_WORKSPACE/rootfs_sanity/${PROFILE}-${MEDIUM}"
          mkdir -p "$OUTDIR"
          python3 "$GITHUB_WORKSPACE/.github/scripts/check_rootfs_ubi.py" \
            --rootfs-img "$ROOTFS_IMG" \
            --outdir "$OUTDIR" \
            --workspace "$GITHUB_WORKSPACE"

      - name: Upload rootfs sanity report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: rootfs-sanity-${{ matrix.profile }}-${{ matrix.medium }}-${{ github.run_id }}
          path: rootfs_sanity/${{ matrix.profile }}-${{ matrix.medium }}/**
          retention-days: 30
          if-no-files-found: warn

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: seedsigner-os-${{ matrix.profile }}-${{ matrix.medium }}-${{ github.run_id }}
          path: |
            build-artifacts/${{ matrix.profile }}-${{ matrix.medium }}/**
          retention-days: 30
          if-no-files-found: warn

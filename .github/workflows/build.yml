name: Build SeedSigner OS

on:
  push:
    branches: [main, develop, master]
  pull_request:
    branches: [main, develop, master]
  workflow_dispatch:
    inputs:
      force_rebuild:
        description: Force rebuild Docker image
        required: false
        default: false
        type: boolean

permissions:
  contents: read

concurrency:
  group: seedsigner-build-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    name: build-${{ matrix.model }}
    runs-on: ubuntu-latest
    timeout-minutes: 240
    strategy:
      fail-fast: false
      matrix:
        model: [mini, max]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Free disk space
        run: |
          echo "Disk usage before cleanup:"
          df -h
          sudo rm -rf /usr/local/lib/android || true
          sudo rm -rf /opt/ghc || true
          sudo docker system prune -af || true
          echo "Disk usage after cleanup:"
          df -h

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build system status
        run: |
          cd buildroot
          ./build.sh status

      - name: Build SeedSigner OS (${{ matrix.model }})
        run: |
          cd buildroot
          echo "ðŸš€ Starting SeedSigner build for model: ${{ matrix.model }}"

          # Set build options
          BUILD_ARGS=""
          if [ "${{ github.event.inputs.force_rebuild }}" = "true" ]; then
            BUILD_ARGS="--force"
          fi

          # Run the build with artifact output to workspace
          ./build.sh build $BUILD_ARGS --microsd --nand --model ${{ matrix.model }} --output ../build-artifacts/${{ matrix.model }}

      - name: Debug Buildroot and repo state before rootfs sanity check
        if: always()
        run: |
          echo "=== BR2-related environment variables ==="
          env | sort | grep -E '^(BR2_EXTERNAL|BR2_)' || true

          echo ""
          echo "=== Buildroot .config candidates ==="
          CONFIGS=$(find "$GITHUB_WORKSPACE" \( -path "*buildroot*/output*/.config" -o -path "*buildroot*/output*/build/.config" \) -type f 2>/dev/null || true)
          if [ -n "$CONFIGS" ]; then
            echo "$CONFIGS"
          else
            echo "No Buildroot .config files found with quick patterns"
          fi

          echo ""
          echo "=== Key package lines from Buildroot configs ==="
          for f in $CONFIGS; do
            echo "=== $f ==="
            grep -E '^(BR2_PACKAGE_EUDEV|BR2_PACKAGE_KMOD|BR2_PACKAGE_UTIL_LINUX|BR2_PACKAGE_UTIL_LINUX_LIBBLKID|BR2_PACKAGE_BUSYBOX|BR2_ROOTFS_OVERLAY)=' "$f" || true
          done

          echo ""
          echo "=== Git SHAs ==="
          git rev-parse HEAD || true
          (cd "$GITHUB_WORKSPACE/buildroot" && git rev-parse HEAD) || true
          (cd "$GITHUB_WORKSPACE/luckfox_pico_sdk" && git rev-parse HEAD && git status --porcelain) || true

      - name: Run NAND rootfs UBI sanity check
        if: always()
        run: |
          python3 -m pip install --user ubi-reader

          ROOTFS_IMG=""
          while IFS= read -r candidate; do
            img_dir=$(dirname "$candidate")
            if [ -f "$img_dir/update.img" ] || [ -f "$img_dir/tftp_update.txt" ]; then
              ROOTFS_IMG="$candidate"
              break
            fi
          done < <(find "$GITHUB_WORKSPACE" -type f -name "rootfs.img")

          echo "NAND ROOTFS_IMG=$ROOTFS_IMG"

          if [ -z "$ROOTFS_IMG" ]; then
            echo "No NAND rootfs.img found; skipping UBI extraction sanity check"
            exit 0
          fi

          python3 .github/scripts/check_rootfs_ubi.py --rootfs-img "$ROOTFS_IMG" --outdir "$GITHUB_WORKSPACE/rootfs_sanity/${{ matrix.model }}" --workspace "$GITHUB_WORKSPACE"

      - name: Upload rootfs sanity report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: rootfs-sanity-${{ matrix.model }}-${{ github.run_id }}
          path: rootfs_sanity/**
          if-no-files-found: warn

      - name: List build artifacts
        if: always()
        run: |
          echo "ðŸŽ¯ Build artifacts for ${{ matrix.model }}:"
          ls -la build-artifacts/${{ matrix.model }}/ || echo "No build artifacts found"

          echo ""
          echo "ðŸ” Searching for SeedSigner images:"
          find build-artifacts/${{ matrix.model }} -name "seedsigner-luckfox-pico*.img" -type f 2>/dev/null || echo "No seedsigner-luckfox-pico images found"

          echo ""
          echo "ðŸ“Š Image sizes:"
          find build-artifacts/${{ matrix.model }} -name "seedsigner-luckfox-pico*.img" -exec du -sh {} \; 2>/dev/null || echo "No images to measure"

          echo ""
          echo "ðŸ“¦ NAND bundle zips:"
          find build-artifacts/${{ matrix.model }} -name "seedsigner-luckfox-pico-*-nand-bundle.zip" -type f 2>/dev/null || echo "No NAND bundle zips found"

          echo ""
          echo "ðŸ—œï¸ NAND bundle tar.gz files:"
          find build-artifacts/${{ matrix.model }} -name "seedsigner-luckfox-pico*.tar.gz" -type f 2>/dev/null || echo "No NAND bundle tar.gz files found"

      - name: Package NAND bundle zips
        if: always()
        run: |
          mkdir -p build-artifacts/${{ matrix.model }}
          shopt -s nullglob

          BUNDLES=(build-artifacts/${{ matrix.model }}/seedsigner-luckfox-pico-*-nand-files-*)
          if [ ${#BUNDLES[@]} -eq 0 ]; then
            echo "No NAND bundle folders found"
          else
            for bundle_dir in "${BUNDLES[@]}"; do
              [ -d "$bundle_dir" ] || continue
              bundle_name=$(basename "$bundle_dir")

              hw_target="unknown"
              if [[ "$bundle_name" =~ seedsigner-luckfox-pico-([^-]+)-nand-files- ]]; then
                hw_target="${BASH_REMATCH[1]}"
              fi

              zip_name="seedsigner-luckfox-pico-${hw_target}-nand-bundle.zip"
              echo "Creating NAND zip: $zip_name from $bundle_name"

              rm -f "build-artifacts/${{ matrix.model }}/$zip_name"
              (cd build-artifacts/${{ matrix.model }} && zip -qr "$zip_name" "$bundle_name")
            done
          fi

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: seedsigner-os-${{ matrix.model }}-${{ github.run_number }}
          path: |
            build-artifacts/${{ matrix.model }}/seedsigner-luckfox-pico*.img
            build-artifacts/${{ matrix.model }}/seedsigner-luckfox-pico-*-nand-bundle.zip
            build-artifacts/${{ matrix.model }}/seedsigner-luckfox-pico*.tar.gz
          retention-days: 30
          if-no-files-found: warn

      - name: Build summary
        if: always()
        run: |
          echo "## ðŸŽ¯ SeedSigner Build Summary (${{ matrix.model }})" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Model**: ${{ matrix.model }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Run Number**: ${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY

          IMG_FILES=$(find build-artifacts/${{ matrix.model }} -name "seedsigner-luckfox-pico*.img" 2>/dev/null || true)
          if [ -n "$IMG_FILES" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸŽ¯ Ready to Flash:" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "$IMG_FILES" | xargs -I {} basename {} >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY

            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ“Š Image Size:" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "$IMG_FILES" | xargs -I {} du -sh {} >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY

            ZIP_FILES=$(find build-artifacts/${{ matrix.model }} -name "seedsigner-luckfox-pico-*-nand-bundle.zip" 2>/dev/null || true)
            if [ -n "$ZIP_FILES" ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "### ðŸ“¦ NAND Bundle Zips:" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              echo "$ZIP_FILES" | xargs -I {} basename {} >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
            fi

            TAR_FILES=$(find build-artifacts/${{ matrix.model }} -name "seedsigner-luckfox-pico*.tar.gz" 2>/dev/null || true)
            if [ -n "$TAR_FILES" ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "### ðŸ—œï¸ NAND Bundle Tarballs:" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              echo "$TAR_FILES" | xargs -I {} basename {} >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "- **Image**: âŒ No seedsigner-luckfox-pico image found" >> $GITHUB_STEP_SUMMARY
          fi

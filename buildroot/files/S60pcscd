#!/bin/sh

SUPERVISOR_PID_FILE="/run/pcscd-supervisor.pid"
PCSCD_LOG_FILE="/tmp/pcscd.log"

start_supervisor() {
    if [ -f "$SUPERVISOR_PID_FILE" ]; then
        pid="$(cat "$SUPERVISOR_PID_FILE" 2>/dev/null)"
        if [ -n "$pid" ] && kill -0 "$pid" 2>/dev/null; then
            echo "pcscd supervisor already running (pid $pid)"
            return 0
        fi
        rm -f "$SUPERVISOR_PID_FILE"
    fi

    (
        trap 'exit 0' TERM INT
        while true; do
            if ! pidof pcscd >/dev/null 2>&1; then
                mkdir -p /run/pcscd
                rm -f /run/pcscd/pcscd.comm
                pcscd --force-reader-polling >>"$PCSCD_LOG_FILE" 2>&1 || true
            fi
            sleep 2
        done
    ) &

    echo "$!" > "$SUPERVISOR_PID_FILE"
    echo "started pcscd supervisor (pid $!)"
}

stop_supervisor() {
    if [ -f "$SUPERVISOR_PID_FILE" ]; then
        pid="$(cat "$SUPERVISOR_PID_FILE" 2>/dev/null)"
        if [ -n "$pid" ] && kill -0 "$pid" 2>/dev/null; then
            kill "$pid" 2>/dev/null || true
            sleep 1
            kill -9 "$pid" 2>/dev/null || true
        fi
        rm -f "$SUPERVISOR_PID_FILE"
    fi

    killall pcscd 2>/dev/null || true
}

case "$1" in
    start)
        start_supervisor
        ;;
    stop)
        stop_supervisor
        ;;
    restart)
        stop_supervisor
        start_supervisor
        ;;
    status)
        if pidof pcscd >/dev/null 2>&1; then
            echo "pcscd running"
            exit 0
        fi
        echo "pcscd not running"
        exit 1
        ;;
    *)
        echo "Usage: $0 {start|stop|restart|status}"
        exit 1
        ;;
esac

exit 0

#!/bin/sh
#
# Start/stop/respawn rkaiq_3A_server for camera ISP support
#
# This service provides the ISP (Image Signal Processor) support needed
# for the camera to function properly with SeedSigner.
#
# The service will automatically restart if it dies.
#

DAEMON=/oem/usr/bin/rkaiq_3A_server
PIDFILE=/var/run/rkaiq_3A_server.pid

start() {
    echo "Starting rkaiq_3A_server..."
    
    # Check if already running
    if [ -f "$PIDFILE" ] && kill -0 $(cat "$PIDFILE") 2>/dev/null; then
        echo "rkaiq_3A_server is already running"
        return 0
    fi
    
    # Start the daemon
    if [ -x "$DAEMON" ]; then
        $DAEMON &
        echo $! > "$PIDFILE"
        echo "rkaiq_3A_server started"
    else
        echo "Error: $DAEMON not found or not executable"
        return 1
    fi
}

stop() {
    echo "Stopping rkaiq_3A_server..."
    
    if [ -f "$PIDFILE" ]; then
        PID=$(cat "$PIDFILE")
        if kill -0 "$PID" 2>/dev/null; then
            kill "$PID"
            rm -f "$PIDFILE"
            echo "rkaiq_3A_server stopped"
        else
            echo "rkaiq_3A_server not running (stale pidfile)"
            rm -f "$PIDFILE"
        fi
    else
        # Fallback to killall if no pidfile
        killall rkaiq_3A_server 2>/dev/null && echo "rkaiq_3A_server stopped" || echo "rkaiq_3A_server not running"
    fi
}

restart() {
    stop
    sleep 1
    start
}

# Auto-restart functionality - keep the service alive
respawn() {
    echo "Starting rkaiq_3A_server with auto-restart..."
    while true; do
        # Check if process is running
        if [ ! -f "$PIDFILE" ] || ! kill -0 $(cat "$PIDFILE") 2>/dev/null; then
            echo "rkaiq_3A_server not running, starting..."
            start
        fi
        sleep 5
    done
}

case "$1" in
    start)
        start
        # Start respawn monitor in background to keep service alive
        (respawn &)
        ;;
    stop)
        stop
        # Kill respawn monitors
        killall -q S50rkaiq 2>/dev/null || true
        ;;
    restart|reload)
        restart
        # Restart respawn monitor
        killall -q S50rkaiq 2>/dev/null || true
        (respawn &)
        ;;
    *)
        echo "Usage: $0 {start|stop|restart|reload}"
        exit 1
        ;;
esac

exit 0
